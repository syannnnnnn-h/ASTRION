name: Notify Discord on Map Update

on:
  push:
    branches:
      - main
    paths:
      - 'localgame.lua'

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Get changed maps
        id: get-maps
        run: |
          # Get diff of localgame.lua
          git diff HEAD^ HEAD -- localgame.lua | grep "^+" | grep "name =" | sed 's/.*name = "\(.*\)".*/\1/' > new_maps.txt || true
          
          # Check if there are new maps
          if [ -s new_maps.txt ]; then
            MAPS=$(cat new_maps.txt | sed 's/^/[+] /')
            echo "maps<<EOF" >> $GITHUB_OUTPUT
            echo "$MAPS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord notification
        if: steps.get-maps.outputs.has_changes == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          MAPS="${{ steps.get-maps.outputs.maps }}"
          
          # Create JSON payload
          PAYLOAD=$(jq -n \
            --arg content "<@&1437983499477848120> **ADDED**\`\`\`diff
$MAPS
\`\`\`
**AUTOMATIC UPDATE!**" \
            --arg username "AstrionHUB Auto Update" \
            --arg avatar "https://ui-avatars.com/api/?name=Astrion&background=30ff6a&color=fff&size=128" \
            '{content: $content, username: $username, avatar_url: $avatar}')
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$WEBHOOK_URL"
