name: Notify Discord on Map Update

on:
  push:
    branches:
      - main
    paths:
      - 'localgame.lua'

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Get changed maps
        id: get-maps
        run: |
          # Get diff and extract new map names
          git diff HEAD^ HEAD -- localgame.lua | grep "^+" | grep "name =" | sed 's/.*name = "\(.*\)".*/\1/' > new_maps.txt
          
          # Read maps and format them
          if [ -s new_maps.txt ]; then
            MAPS=$(cat new_maps.txt | sed 's/^/[+] /' | tr '\n' '\n')
            echo "maps<<EOF" >> $GITHUB_OUTPUT
            echo "$MAPS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord notification
        if: steps.get-maps.outputs.has_changes == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "content": "<@&1437983499477848120> **ADDED**\n```diff\n${{ steps.get-maps.outputs.maps }}\n```\n**AUTOMATIC UPDATE!**",
                 "username": "AstrionHUB Auto Update",
                 "avatar_url": "https://ui-avatars.com/api/?name=Astrion&background=30ff6a&color=fff&size=128"
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
